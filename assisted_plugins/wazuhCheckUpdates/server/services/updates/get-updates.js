"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getUpdates = void 0;
var _types = require("../../../common/types");
var _constants = require("../../../common/constants");
var _savedObject = require("../saved-object");
var _pluginServices = require("../../plugin-services");
const getUpdates = async (queryApi = false, forceQuery = false) => {
  try {
    if (!queryApi) {
      const availableUpdates = await (0, _savedObject.getSavedObject)(_constants.SAVED_OBJECT_UPDATES);
      return availableUpdates;
    }
    const {
      manageHosts,
      api: wazuhApiClient
    } = (0, _pluginServices.getWazuhCore)();
    const hosts = await manageHosts.get();
    const apisAvailableUpdates = await Promise.all(hosts === null || hosts === void 0 ? void 0 : hosts.map(async api => {
      const data = {};
      const method = 'GET';
      const path = `/manager/version/check?force_query=${forceQuery}`;
      const options = {
        apiHostID: api.id,
        forceRefresh: true
      };
      try {
        const response = await wazuhApiClient.client.asInternalUser.request(method, path, data, options);
        const update = response.data.data;
        const {
          current_version,
          update_check,
          last_available_major,
          last_available_minor,
          last_available_patch,
          last_check_date
        } = update;
        const getStatus = () => {
          if (update_check === false) {
            return _types.API_UPDATES_STATUS.DISABLED;
          }
          if (last_available_major !== null && last_available_major !== void 0 && last_available_major.tag || last_available_minor !== null && last_available_minor !== void 0 && last_available_minor.tag || last_available_patch !== null && last_available_patch !== void 0 && last_available_patch.tag) {
            return _types.API_UPDATES_STATUS.AVAILABLE_UPDATES;
          }
          return _types.API_UPDATES_STATUS.UP_TO_DATE;
        };
        return {
          current_version,
          update_check,
          last_available_major,
          last_available_minor,
          last_available_patch,
          last_check_date: last_check_date || undefined,
          api_id: api.id,
          status: getStatus()
        };
      } catch (e) {
        var _e$response, _e$response$data$deta, _e$response2;
        const error = {
          title: (_e$response = e.response) === null || _e$response === void 0 || (_e$response = _e$response.data) === null || _e$response === void 0 ? void 0 : _e$response.title,
          detail: (_e$response$data$deta = (_e$response2 = e.response) === null || _e$response2 === void 0 || (_e$response2 = _e$response2.data) === null || _e$response2 === void 0 ? void 0 : _e$response2.detail) !== null && _e$response$data$deta !== void 0 ? _e$response$data$deta : e.message
        };
        return {
          api_id: api.id,
          status: _types.API_UPDATES_STATUS.ERROR,
          error
        };
      }
    }));
    const savedObject = {
      apis_available_updates: apisAvailableUpdates,
      last_check_date: new Date()
    };
    await (0, _savedObject.setSavedObject)(_constants.SAVED_OBJECT_UPDATES, savedObject);
    return savedObject;
  } catch (error) {
    const message = error instanceof Error ? error.message : typeof error === 'string' ? error : 'Error trying to get available updates';
    const {
      logger
    } = (0, _pluginServices.getWazuhCheckUpdatesServices)();
    logger.error(message);
    return Promise.reject(error);
  }
};
exports.getUpdates = getUpdates;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfdHlwZXMiLCJyZXF1aXJlIiwiX2NvbnN0YW50cyIsIl9zYXZlZE9iamVjdCIsIl9wbHVnaW5TZXJ2aWNlcyIsImdldFVwZGF0ZXMiLCJxdWVyeUFwaSIsImZvcmNlUXVlcnkiLCJhdmFpbGFibGVVcGRhdGVzIiwiZ2V0U2F2ZWRPYmplY3QiLCJTQVZFRF9PQkpFQ1RfVVBEQVRFUyIsIm1hbmFnZUhvc3RzIiwiYXBpIiwid2F6dWhBcGlDbGllbnQiLCJnZXRXYXp1aENvcmUiLCJob3N0cyIsImdldCIsImFwaXNBdmFpbGFibGVVcGRhdGVzIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsImRhdGEiLCJtZXRob2QiLCJwYXRoIiwib3B0aW9ucyIsImFwaUhvc3RJRCIsImlkIiwiZm9yY2VSZWZyZXNoIiwicmVzcG9uc2UiLCJjbGllbnQiLCJhc0ludGVybmFsVXNlciIsInJlcXVlc3QiLCJ1cGRhdGUiLCJjdXJyZW50X3ZlcnNpb24iLCJ1cGRhdGVfY2hlY2siLCJsYXN0X2F2YWlsYWJsZV9tYWpvciIsImxhc3RfYXZhaWxhYmxlX21pbm9yIiwibGFzdF9hdmFpbGFibGVfcGF0Y2giLCJsYXN0X2NoZWNrX2RhdGUiLCJnZXRTdGF0dXMiLCJBUElfVVBEQVRFU19TVEFUVVMiLCJESVNBQkxFRCIsInRhZyIsIkFWQUlMQUJMRV9VUERBVEVTIiwiVVBfVE9fREFURSIsInVuZGVmaW5lZCIsImFwaV9pZCIsInN0YXR1cyIsImUiLCJfZSRyZXNwb25zZSIsIl9lJHJlc3BvbnNlJGRhdGEkZGV0YSIsIl9lJHJlc3BvbnNlMiIsImVycm9yIiwidGl0bGUiLCJkZXRhaWwiLCJtZXNzYWdlIiwiRVJST1IiLCJzYXZlZE9iamVjdCIsImFwaXNfYXZhaWxhYmxlX3VwZGF0ZXMiLCJEYXRlIiwic2V0U2F2ZWRPYmplY3QiLCJFcnJvciIsImxvZ2dlciIsImdldFdhenVoQ2hlY2tVcGRhdGVzU2VydmljZXMiLCJyZWplY3QiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiZ2V0LXVwZGF0ZXMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQVBJX1VQREFURVNfU1RBVFVTLFxuICBBdmFpbGFibGVVcGRhdGVzLFxuICBSZXNwb25zZUFwaUF2YWlsYWJsZVVwZGF0ZXMsXG59IGZyb20gJy4uLy4uLy4uL2NvbW1vbi90eXBlcyc7XG5pbXBvcnQgeyBTQVZFRF9PQkpFQ1RfVVBEQVRFUyB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9jb25zdGFudHMnO1xuaW1wb3J0IHsgZ2V0U2F2ZWRPYmplY3QsIHNldFNhdmVkT2JqZWN0IH0gZnJvbSAnLi4vc2F2ZWQtb2JqZWN0JztcbmltcG9ydCB7XG4gIGdldFdhenVoQ2hlY2tVcGRhdGVzU2VydmljZXMsXG4gIGdldFdhenVoQ29yZSxcbn0gZnJvbSAnLi4vLi4vcGx1Z2luLXNlcnZpY2VzJztcblxuZXhwb3J0IGNvbnN0IGdldFVwZGF0ZXMgPSBhc3luYyAoXG4gIHF1ZXJ5QXBpID0gZmFsc2UsXG4gIGZvcmNlUXVlcnkgPSBmYWxzZSxcbik6IFByb21pc2U8QXZhaWxhYmxlVXBkYXRlcz4gPT4ge1xuICB0cnkge1xuICAgIGlmICghcXVlcnlBcGkpIHtcbiAgICAgIGNvbnN0IGF2YWlsYWJsZVVwZGF0ZXMgPSAoYXdhaXQgZ2V0U2F2ZWRPYmplY3QoXG4gICAgICAgIFNBVkVEX09CSkVDVF9VUERBVEVTLFxuICAgICAgKSkgYXMgQXZhaWxhYmxlVXBkYXRlcztcblxuICAgICAgcmV0dXJuIGF2YWlsYWJsZVVwZGF0ZXM7XG4gICAgfVxuXG4gICAgY29uc3QgeyBtYW5hZ2VIb3N0cywgYXBpOiB3YXp1aEFwaUNsaWVudCB9ID0gZ2V0V2F6dWhDb3JlKCk7XG5cbiAgICBjb25zdCBob3N0czogeyBpZDogc3RyaW5nIH1bXSA9IGF3YWl0IG1hbmFnZUhvc3RzLmdldCgpO1xuXG4gICAgY29uc3QgYXBpc0F2YWlsYWJsZVVwZGF0ZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIGhvc3RzPy5tYXAoYXN5bmMgYXBpID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHt9O1xuICAgICAgICBjb25zdCBtZXRob2QgPSAnR0VUJztcbiAgICAgICAgY29uc3QgcGF0aCA9IGAvbWFuYWdlci92ZXJzaW9uL2NoZWNrP2ZvcmNlX3F1ZXJ5PSR7Zm9yY2VRdWVyeX1gO1xuICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgIGFwaUhvc3RJRDogYXBpLmlkLFxuICAgICAgICAgIGZvcmNlUmVmcmVzaDogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHdhenVoQXBpQ2xpZW50LmNsaWVudC5hc0ludGVybmFsVXNlci5yZXF1ZXN0KFxuICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBjb25zdCB1cGRhdGUgPSByZXNwb25zZS5kYXRhLmRhdGEgYXMgUmVzcG9uc2VBcGlBdmFpbGFibGVVcGRhdGVzO1xuXG4gICAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgY3VycmVudF92ZXJzaW9uLFxuICAgICAgICAgICAgdXBkYXRlX2NoZWNrLFxuICAgICAgICAgICAgbGFzdF9hdmFpbGFibGVfbWFqb3IsXG4gICAgICAgICAgICBsYXN0X2F2YWlsYWJsZV9taW5vcixcbiAgICAgICAgICAgIGxhc3RfYXZhaWxhYmxlX3BhdGNoLFxuICAgICAgICAgICAgbGFzdF9jaGVja19kYXRlLFxuICAgICAgICAgIH0gPSB1cGRhdGU7XG5cbiAgICAgICAgICBjb25zdCBnZXRTdGF0dXMgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAodXBkYXRlX2NoZWNrID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICByZXR1cm4gQVBJX1VQREFURVNfU1RBVFVTLkRJU0FCTEVEO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIGxhc3RfYXZhaWxhYmxlX21ham9yPy50YWcgfHxcbiAgICAgICAgICAgICAgbGFzdF9hdmFpbGFibGVfbWlub3I/LnRhZyB8fFxuICAgICAgICAgICAgICBsYXN0X2F2YWlsYWJsZV9wYXRjaD8udGFnXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIEFQSV9VUERBVEVTX1NUQVRVUy5BVkFJTEFCTEVfVVBEQVRFUztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIEFQSV9VUERBVEVTX1NUQVRVUy5VUF9UT19EQVRFO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY3VycmVudF92ZXJzaW9uLFxuICAgICAgICAgICAgdXBkYXRlX2NoZWNrLFxuICAgICAgICAgICAgbGFzdF9hdmFpbGFibGVfbWFqb3IsXG4gICAgICAgICAgICBsYXN0X2F2YWlsYWJsZV9taW5vcixcbiAgICAgICAgICAgIGxhc3RfYXZhaWxhYmxlX3BhdGNoLFxuICAgICAgICAgICAgbGFzdF9jaGVja19kYXRlOiBsYXN0X2NoZWNrX2RhdGUgfHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgYXBpX2lkOiBhcGkuaWQsXG4gICAgICAgICAgICBzdGF0dXM6IGdldFN0YXR1cygpLFxuICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgICAgIGNvbnN0IGVycm9yID0ge1xuICAgICAgICAgICAgdGl0bGU6IGUucmVzcG9uc2U/LmRhdGE/LnRpdGxlLFxuICAgICAgICAgICAgZGV0YWlsOiBlLnJlc3BvbnNlPy5kYXRhPy5kZXRhaWwgPz8gZS5tZXNzYWdlLFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYXBpX2lkOiBhcGkuaWQsXG4gICAgICAgICAgICBzdGF0dXM6IEFQSV9VUERBVEVTX1NUQVRVUy5FUlJPUixcbiAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBjb25zdCBzYXZlZE9iamVjdCA9IHtcbiAgICAgIGFwaXNfYXZhaWxhYmxlX3VwZGF0ZXM6IGFwaXNBdmFpbGFibGVVcGRhdGVzLFxuICAgICAgbGFzdF9jaGVja19kYXRlOiBuZXcgRGF0ZSgpLFxuICAgIH07XG5cbiAgICBhd2FpdCBzZXRTYXZlZE9iamVjdChTQVZFRF9PQkpFQ1RfVVBEQVRFUywgc2F2ZWRPYmplY3QpO1xuXG4gICAgcmV0dXJuIHNhdmVkT2JqZWN0O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvclxuICAgICAgICA/IGVycm9yLm1lc3NhZ2VcbiAgICAgICAgOiB0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnXG4gICAgICAgID8gZXJyb3JcbiAgICAgICAgOiAnRXJyb3IgdHJ5aW5nIHRvIGdldCBhdmFpbGFibGUgdXBkYXRlcyc7XG5cbiAgICBjb25zdCB7IGxvZ2dlciB9ID0gZ2V0V2F6dWhDaGVja1VwZGF0ZXNTZXJ2aWNlcygpO1xuXG4gICAgbG9nZ2VyLmVycm9yKG1lc3NhZ2UpO1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7XG4gIH1cbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQUFBLE1BQUEsR0FBQUMsT0FBQTtBQUtBLElBQUFDLFVBQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLFlBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLGVBQUEsR0FBQUgsT0FBQTtBQUtPLE1BQU1JLFVBQVUsR0FBRyxNQUFBQSxDQUN4QkMsUUFBUSxHQUFHLEtBQUssRUFDaEJDLFVBQVUsR0FBRyxLQUFLLEtBQ1k7RUFDOUIsSUFBSTtJQUNGLElBQUksQ0FBQ0QsUUFBUSxFQUFFO01BQ2IsTUFBTUUsZ0JBQWdCLEdBQUksTUFBTSxJQUFBQywyQkFBYyxFQUM1Q0MsK0JBQ0YsQ0FBc0I7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