"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ManageHosts = void 0;
var _apiUserStatusRunAs = require("../../common/api-user-status-run-as");
var _constants = require("../../common/constants");
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); } /*
 * Wazuh app - Module to update the configuration file
 * Copyright (C) 2015-2022 Wazuh, Inc.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * Find more information about this on the LICENSE file.
 */
/**
 * This service manages the API connections.
 * Get API hosts configuration
 * Get API host entries (combine configuration and registry data)
 * Create API host
 * Update API host
 * Delete API host
 * Cache the registry data for API hosts
 * Ability to get if the configured user is allowed to use run as
 */
class ManageHosts {
  constructor(logger, configuration) {
    this.logger = logger;
    this.configuration = configuration;
    _defineProperty(this, "serverAPIClient", null);
    _defineProperty(this, "cacheRegistry", new Map());
  }
  setServerAPIClient(client) {
    this.serverAPIClient = client;
  }
  /**
   * Exclude fields from an API host data
   * @param host
   * @param exclude
   * @returns
   */
  filterAPIHostData(host, exclude) {
    return exclude !== null && exclude !== void 0 && exclude.length ? Object.entries(host).reduce((accum, [key, value]) => ({
      ...accum,
      ...(!exclude.includes(key) ? {
        [key]: value
      } : {})
    }), {}) : host;
  }

  /**
   * Get hosts or host by ID from configuration
   */
  async get(hostID, options = {
    excludePassword: false
  }) {
    try {
      hostID ? this.logger.debug(`Getting API connection with ID [${hostID}]`) : this.logger.debug('Getting API connections');
      const hosts = await this.configuration.get('hosts');
      this.logger.debug(`API connections: [${JSON.stringify(hosts)}]`);
      if (hostID) {
        const host = hosts.find(({
          id
        }) => id === hostID);
        if (host) {
          this.logger.debug(`API connection with ID [${hostID}] found`);
          return this.filterAPIHostData(host, options.excludePassword ? ['password'] : undefined);
        }
        const APIConnectionNotFound = `API connection with ID [${hostID}] not found`;
        this.logger.debug(APIConnectionNotFound);
        throw new Error(APIConnectionNotFound);
      }
      return hosts.map(host => this.filterAPIHostData(host, options.excludePassword ? ['password'] : undefined));
    } catch (error) {
      this.logger.error(error.message);
      throw error;
    }
  }

  /**
   * This get all hosts entries in the plugins configuration and the related info in the wazuh-registry.json
   * @param {Object} context
   * @param {Object} request
   * @param {Object} response
   * API entries
   */
  async getEntries(options = {
    excludePassword: false
  }) {
    try {
      this.logger.debug('Getting the API connections');
      const hosts = await this.get(undefined, options);
      this.logger.debug('Getting registry');
      const registry = Object.fromEntries([...this.cacheRegistry.entries()]);
      return hosts.map(host => {
        const {
          id
        } = host;
        return {
          ...host,
          cluster_info: registry[id]
        };
      });
    } catch (error) {
      this.logger.error(error.message);
      throw error;
    }
  }
  isServerAPIClientResponseOk(response) {
    return response.status === _constants.HTTP_STATUS_CODES.OK;
  }

  /**
   * Get the cluster info and allow_run_as values for the API host and store into the registry cache
   * @param host
   * @returns
   */
  async getRegistryDataByHost(host, options) {
    const apiHostID = host.id;
    this.logger.debug(`Getting registry data from host [${apiHostID}]`);
    // Get cluster info data

    let manager = null,
      node = null,
      status = 'disabled',
      cluster = 'Disabled',
      allow_run_as = _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.UNABLE_TO_CHECK;
    try {
      var _responseClusterStatu;
      const responseAgents = await this.serverAPIClient.asInternalUser.request('GET', `/agents`, {
        params: {
          agents_list: '000'
        }
      }, {
        apiHostID
      });
      if (this.isServerAPIClientResponseOk(responseAgents)) {
        manager = responseAgents.data.data.affected_items[0].manager;
      }

      // Get allow_run_as
      const responseAllowRunAs = await this.serverAPIClient.asInternalUser.request('GET', '/security/users/me', {}, {
        apiHostID
      });
      if (this.isServerAPIClientResponseOk(responseAllowRunAs)) {
        const allow_run_as_response = responseAllowRunAs.data.data.affected_items[0].allow_run_as;
        if (host.run_as) {
          allow_run_as = allow_run_as_response ? _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ENABLED : _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.USER_NOT_ALLOWED;
        } else {
          allow_run_as = allow_run_as_response ? _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.HOST_DISABLED : _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ALL_DISABLED;
        }
      }
      const responseClusterStatus = await this.serverAPIClient.asInternalUser.request('GET', `/cluster/status`, {}, {
        apiHostID
      });
      if (this.isServerAPIClientResponseOk(responseClusterStatus) && ((_responseClusterStatu = responseClusterStatus.data) === null || _responseClusterStatu === void 0 || (_responseClusterStatu = _responseClusterStatu.data) === null || _responseClusterStatu === void 0 ? void 0 : _responseClusterStatu.enabled) === 'yes') {
        status = 'enabled';
        const responseClusterLocal = await this.serverAPIClient.asInternalUser.request('GET', `/cluster/local/info`, {}, {
          apiHostID
        });
        if (this.isServerAPIClientResponseOk(responseClusterLocal)) {
          node = responseClusterLocal.data.data.affected_items[0].node;
          cluster = responseClusterLocal.data.data.affected_items[0].cluster;
        }
      }
    } catch (error) {
      if (options !== null && options !== void 0 && options.throwError) {
        throw error;
      }
    }
    const data = {
      manager,
      node,
      status,
      cluster,
      allow_run_as
    };
    this.updateRegistryByHost(apiHostID, data);
    return data;
  }

  /**
   * Initialize the service on plugin start.
   * - Get the registry data for the configured API hosts and store into the in memory cache
   * @returns
   */
  async start() {
    try {
      this.logger.debug('Start');
      const hosts = await this.get(undefined, {
        excludePassword: true
      });
      if (!hosts.length) {
        this.logger.debug('No hosts found. Skip.');
        return;
      }
      await Promise.all(hosts.map(host => (async () => [host.id, await this.getRegistryDataByHost(host)])()));
      this.logger.debug('API hosts data stored in the registry');
    } catch (error) {
      this.logger.error(error.message);
      throw error;
    }
  }
  getRegistryByHost(hostID) {
    this.logger.debug(`Getting cache for API host [${hostID}]`);
    const result = this.cacheRegistry.get(hostID);
    this.logger.debug(`Get cache for APIhost [${hostID}]`);
    return result;
  }
  updateRegistryByHost(hostID, data) {
    this.logger.debug(`Updating cache for APIhost [${hostID}]`);
    const result = this.cacheRegistry.set(hostID, data);
    this.logger.debug(`Updated cache for APIhost [${hostID}]`);
    return result;
  }
  deleteRegistryByHost(hostID) {
    this.logger.debug(`Deleting cache for API host [${hostID}]`);
    const result = this.cacheRegistry.delete(hostID);
    this.logger.debug(`Deleted cache for API host [${hostID}]`);
    return result;
  }

  /**
   * Check if the authentication with run_as is enabled and the API user can use it
   * @param apiId
   * @returns
   */
  isEnabledAuthWithRunAs(apiId) {
    this.logger.debug(`Checking if the API host [${apiId}] can use the run_as`);
    const registryHost = this.getRegistryByHost(apiId);
    if (!registryHost) {
      throw new Error(`API host with ID [${apiId}] was not found in the registry. This could be caused by a problem getting and storing the registry data or the API host was removed.`);
    }
    if (registryHost.allow_run_as === _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.UNABLE_TO_CHECK) {
      throw new Error(`API host with host ID [${apiId}] could not check the ability to use the run as. Ensure the API host is accesible and the internal user has the minimal permissions to check this capability.`);
    }
    if (registryHost.allow_run_as === _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.USER_NOT_ALLOWED) {
      throw new Error(`API host with host ID [${apiId}] misconfigured. The configurated API user is not allowed to use [run_as]. Allow it in the API user configuration or set [run_as] host setting with [false] value.`);
    }

    /* The allowed values to compare should be:
      API_USER_STATUS_RUN_AS.ENABLED: use run_as
      API_USER_STATUS_RUN_AS.HOST_DISABLED: not use run_as
      API_USER_STATUS_RUN_AS.ALL_DISABLED: not use run_as
    */
    if (![_apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ENABLED, _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.HOST_DISABLED, _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ALL_DISABLED].includes(registryHost.allow_run_as)) {
      throw new Error(`API host with host ID [${apiId}] has an unexpected value [${registryHost.allow_run_as}] stored in the registry. This could be caused by a problem getting and storing the registry data.`);
    }
    return registryHost.allow_run_as === _apiUserStatusRunAs.API_USER_STATUS_RUN_AS.ENABLED;
  }
}
exports.ManageHosts = ManageHosts;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXBpVXNlclN0YXR1c1J1bkFzIiwicmVxdWlyZSIsIl9jb25zdGFudHMiLCJfZGVmaW5lUHJvcGVydHkiLCJvYmoiLCJrZXkiLCJ2YWx1ZSIsIl90b1Byb3BlcnR5S2V5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwid3JpdGFibGUiLCJhcmciLCJfdG9QcmltaXRpdmUiLCJTdHJpbmciLCJpbnB1dCIsImhpbnQiLCJwcmltIiwiU3ltYm9sIiwidG9QcmltaXRpdmUiLCJ1bmRlZmluZWQiLCJyZXMiLCJjYWxsIiwiVHlwZUVycm9yIiwiTnVtYmVyIiwiTWFuYWdlSG9zdHMiLCJjb25zdHJ1Y3RvciIsImxvZ2dlciIsImNvbmZpZ3VyYXRpb24iLCJNYXAiLCJzZXRTZXJ2ZXJBUElDbGllbnQiLCJjbGllbnQiLCJzZXJ2ZXJBUElDbGllbnQiLCJmaWx0ZXJBUElIb3N0RGF0YSIsImhvc3QiLCJleGNsdWRlIiwibGVuZ3RoIiwiZW50cmllcyIsInJlZHVjZSIsImFjY3VtIiwiaW5jbHVkZXMiLCJnZXQiLCJob3N0SUQiLCJvcHRpb25zIiwiZXhjbHVkZVBhc3N3b3JkIiwiZGVidWciLCJob3N0cyIsIkpTT04iLCJzdHJpbmdpZnkiLCJmaW5kIiwiaWQiLCJBUElDb25uZWN0aW9uTm90Rm91bmQiLCJFcnJvciIsIm1hcCIsImVycm9yIiwibWVzc2FnZSIsImdldEVudHJpZXMiLCJyZWdpc3RyeSIsImZyb21FbnRyaWVzIiwiY2FjaGVSZWdpc3RyeSIsImNsdXN0ZXJfaW5mbyIsImlzU2VydmVyQVBJQ2xpZW50UmVzcG9uc2VPayIsInJlc3BvbnNlIiwic3RhdHVzIiwiSFRUUF9TVEFUVVNfQ09ERVMiLCJPSyIsImdldFJlZ2lzdHJ5RGF0YUJ5SG9zdCIsImFwaUhvc3RJRCIsIm1hbmFnZXIiLCJub2RlIiwiY2x1c3RlciIsImFsbG93X3J1bl9hcyIsIkFQSV9VU0VSX1NUQVRVU19SVU5fQVMiLCJVTkFCTEVfVE9fQ0hFQ0siLCJfcmVzcG9uc2VDbHVzdGVyU3RhdHUiLCJyZXNwb25zZUFnZW50cyIsImFzSW50ZXJuYWxVc2VyIiwicmVxdWVzdCIsInBhcmFtcyIsImFnZW50c19saXN0IiwiZGF0YSIsImFmZmVjdGVkX2l0ZW1zIiwicmVzcG9uc2VBbGxvd1J1bkFzIiwiYWxsb3dfcnVuX2FzX3Jlc3BvbnNlIiwicnVuX2FzIiwiRU5BQkxFRCIsIlVTRVJfTk9UX0FMTE9XRUQiLCJIT1NUX0RJU0FCTEVEIiwiQUxMX0RJU0FCTEVEIiwicmVzcG9uc2VDbHVzdGVyU3RhdHVzIiwiZW5hYmxlZCIsInJlc3BvbnNlQ2x1c3RlckxvY2FsIiwidGhyb3dFcnJvciIsInVwZGF0ZVJlZ2lzdHJ5QnlIb3N0Iiwic3RhcnQiLCJQcm9taXNlIiwiYWxsIiwiZ2V0UmVnaXN0cnlCeUhvc3QiLCJyZXN1bHQiLCJzZXQiLCJkZWxldGVSZWdpc3RyeUJ5SG9zdCIsImRlbGV0ZSIsImlzRW5hYmxlZEF1dGhXaXRoUnVuQXMiLCJhcGlJZCIsInJlZ2lzdHJ5SG9zdCIsImV4cG9ydHMiXSwic291cmNlcyI6WyJtYW5hZ2UtaG9zdHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFdhenVoIGFwcCAtIE1vZHVsZSB0byB1cGRhdGUgdGhlIGNvbmZpZ3VyYXRpb24gZmlsZVxuICogQ29weXJpZ2h0IChDKSAyMDE1LTIwMjIgV2F6dWgsIEluYy5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDIgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIEZpbmQgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCB0aGlzIG9uIHRoZSBMSUNFTlNFIGZpbGUuXG4gKi9cbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJ29wZW5zZWFyY2gtZGFzaGJvYXJkcy9zZXJ2ZXInO1xuaW1wb3J0IHsgSUNvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9jb21tb24vc2VydmljZXMvY29uZmlndXJhdGlvbic7XG5pbXBvcnQgeyBTZXJ2ZXJBUElDbGllbnQgfSBmcm9tICcuL3NlcnZlci1hcGktY2xpZW50JztcbmltcG9ydCB7IEFQSV9VU0VSX1NUQVRVU19SVU5fQVMgfSBmcm9tICcuLi8uLi9jb21tb24vYXBpLXVzZXItc3RhdHVzLXJ1bi1hcyc7XG5pbXBvcnQgeyBIVFRQX1NUQVRVU19DT0RFUyB9IGZyb20gJy4uLy4uL2NvbW1vbi9jb25zdGFudHMnO1xuXG5pbnRlcmZhY2UgSUFQSUhvc3Qge1xuICBpZDogc3RyaW5nO1xuICB1cmw6IHN0cmluZztcbiAgdXNlcm5hbWU6IHN0cmluZztcbiAgcGFzc3dvcmQ6IHN0cmluZztcbiAgcG9ydDogbnVtYmVyO1xuICBydW5fYXM6IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBJQVBJSG9zdFJlZ2lzdHJ5IHtcbiAgbWFuYWdlcjogc3RyaW5nIHwgbnVsbDtcbiAgbm9kZTogc3RyaW5nIHwgbnVsbDtcbiAgc3RhdHVzOiBzdHJpbmc7XG4gIGNsdXN0ZXI6IHN0cmluZztcbiAgYWxsb3dfcnVuX2FzOiBBUElfVVNFUl9TVEFUVVNfUlVOX0FTO1xufVxuXG5pbnRlcmZhY2UgR2V0UmVnaXN0cnlEYXRhQnlIb3N0T3B0aW9ucyB7XG4gIC8qIHRoaXMgb3B0aW9uIGxldHMgdG8gdGhyb3cgdGhlIGVycm9yIHdoZW4gdHJ5aW5nIHRvIGZldGNoIHRoZSByZXF1aXJlZCBkYXRhXG4gIG9mIHRoZSBBUEkgaG9zdCB0aGF0IGlzIHVzZWQgYnkgdGhlIGNoZWNrU3RvcmVkQVBJIG9mIC9hcGkvY2hlY2stc3RvcmVkLWFwaVxuICBlbmRwb2ludCAqL1xuICB0aHJvd0Vycm9yOiBib29sZWFuO1xufVxuXG4vKipcbiAqIFRoaXMgc2VydmljZSBtYW5hZ2VzIHRoZSBBUEkgY29ubmVjdGlvbnMuXG4gKiBHZXQgQVBJIGhvc3RzIGNvbmZpZ3VyYXRpb25cbiAqIEdldCBBUEkgaG9zdCBlbnRyaWVzIChjb21iaW5lIGNvbmZpZ3VyYXRpb24gYW5kIHJlZ2lzdHJ5IGRhdGEpXG4gKiBDcmVhdGUgQVBJIGhvc3RcbiAqIFVwZGF0ZSBBUEkgaG9zdFxuICogRGVsZXRlIEFQSSBob3N0XG4gKiBDYWNoZSB0aGUgcmVnaXN0cnkgZGF0YSBmb3IgQVBJIGhvc3RzXG4gKiBBYmlsaXR5IHRvIGdldCBpZiB0aGUgY29uZmlndXJlZCB1c2VyIGlzIGFsbG93ZWQgdG8gdXNlIHJ1biBhc1xuICovXG5leHBvcnQgY2xhc3MgTWFuYWdlSG9zdHMge1xuICBwdWJsaWMgc2VydmVyQVBJQ2xpZW50OiBTZXJ2ZXJBUElDbGllbnQgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBjYWNoZVJlZ2lzdHJ5OiBNYXA8c3RyaW5nLCBJQVBJSG9zdFJlZ2lzdHJ5PiA9IG5ldyBNYXAoKTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2dnZXI6IExvZ2dlciwgcHJpdmF0ZSBjb25maWd1cmF0aW9uOiBJQ29uZmlndXJhdGlvbikge31cblxuICBzZXRTZXJ2ZXJBUElDbGllbnQoY2xpZW50OiBTZXJ2ZXJBUElDbGllbnQpIHtcbiAgICB0aGlzLnNlcnZlckFQSUNsaWVudCA9IGNsaWVudDtcbiAgfVxuICAvKipcbiAgICogRXhjbHVkZSBmaWVsZHMgZnJvbSBhbiBBUEkgaG9zdCBkYXRhXG4gICAqIEBwYXJhbSBob3N0XG4gICAqIEBwYXJhbSBleGNsdWRlXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBwcml2YXRlIGZpbHRlckFQSUhvc3REYXRhKGhvc3Q6IElBUElIb3N0LCBleGNsdWRlOiBzdHJpbmdbXSkge1xuICAgIHJldHVybiBleGNsdWRlPy5sZW5ndGhcbiAgICAgID8gT2JqZWN0LmVudHJpZXMoaG9zdCkucmVkdWNlKFxuICAgICAgICAgIChhY2N1bSwgW2tleSwgdmFsdWVdKSA9PiAoe1xuICAgICAgICAgICAgLi4uYWNjdW0sXG4gICAgICAgICAgICAuLi4oIWV4Y2x1ZGUuaW5jbHVkZXMoa2V5KSA/IHsgW2tleV06IHZhbHVlIH0gOiB7fSksXG4gICAgICAgICAgfSksXG4gICAgICAgICAge30sXG4gICAgICAgIClcbiAgICAgIDogaG9zdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgaG9zdHMgb3IgaG9zdCBieSBJRCBmcm9tIGNvbmZpZ3VyYXRpb25cbiAgICovXG4gIGFzeW5jIGdldChcbiAgICBob3N0SUQ/OiBzdHJpbmcsXG4gICAgb3B0aW9uczogeyBleGNsdWRlUGFzc3dvcmQ6IGJvb2xlYW4gfSA9IHsgZXhjbHVkZVBhc3N3b3JkOiBmYWxzZSB9LFxuICApOiBQcm9taXNlPElBUElIb3N0W10gfCBJQVBJSG9zdD4ge1xuICAgIHRyeSB7XG4gICAgICBob3N0SURcbiAgICAgICAgPyB0aGlzLmxvZ2dlci5kZWJ1ZyhgR2V0dGluZyBBUEkgY29ubmVjdGlvbiB3aXRoIElEIFske2hvc3RJRH1dYClcbiAgICAgICAgOiB0aGlzLmxvZ2dlci5kZWJ1ZygnR2V0dGluZyBBUEkgY29ubmVjdGlvbnMnKTtcbiAgICAgIGNvbnN0IGhvc3RzID0gYXdhaXQgdGhpcy5jb25maWd1cmF0aW9uLmdldCgnaG9zdHMnKTtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBBUEkgY29ubmVjdGlvbnM6IFske0pTT04uc3RyaW5naWZ5KGhvc3RzKX1dYCk7XG4gICAgICBpZiAoaG9zdElEKSB7XG4gICAgICAgIGNvbnN0IGhvc3QgPSBob3N0cy5maW5kKCh7IGlkIH06IHsgaWQ6IHN0cmluZyB9KSA9PiBpZCA9PT0gaG9zdElEKTtcbiAgICAgICAgaWYgKGhvc3QpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgQVBJIGNvbm5lY3Rpb24gd2l0aCBJRCBbJHtob3N0SUR9XSBmb3VuZGApO1xuICAgICAgICAgIHJldHVybiB0aGlzLmZpbHRlckFQSUhvc3REYXRhKFxuICAgICAgICAgICAgaG9zdCxcbiAgICAgICAgICAgIG9wdGlvbnMuZXhjbHVkZVBhc3N3b3JkID8gWydwYXNzd29yZCddIDogdW5kZWZpbmVkLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgQVBJQ29ubmVjdGlvbk5vdEZvdW5kID0gYEFQSSBjb25uZWN0aW9uIHdpdGggSUQgWyR7aG9zdElEfV0gbm90IGZvdW5kYDtcbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoQVBJQ29ubmVjdGlvbk5vdEZvdW5kKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKEFQSUNvbm5lY3Rpb25Ob3RGb3VuZCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gaG9zdHMubWFwKGhvc3QgPT5cbiAgICAgICAgdGhpcy5maWx0ZXJBUElIb3N0RGF0YShcbiAgICAgICAgICBob3N0LFxuICAgICAgICAgIG9wdGlvbnMuZXhjbHVkZVBhc3N3b3JkID8gWydwYXNzd29yZCddIDogdW5kZWZpbmVkLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBnZXQgYWxsIGhvc3RzIGVudHJpZXMgaW4gdGhlIHBsdWdpbnMgY29uZmlndXJhdGlvbiBhbmQgdGhlIHJlbGF0ZWQgaW5mbyBpbiB0aGUgd2F6dWgtcmVnaXN0cnkuanNvblxuICAgKiBAcGFyYW0ge09iamVjdH0gY29udGV4dFxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdFxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2VcbiAgICogQVBJIGVudHJpZXNcbiAgICovXG4gIGFzeW5jIGdldEVudHJpZXMoXG4gICAgb3B0aW9uczogeyBleGNsdWRlUGFzc3dvcmQ6IGJvb2xlYW4gfSA9IHsgZXhjbHVkZVBhc3N3b3JkOiBmYWxzZSB9LFxuICApIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2dnZXIuZGVidWcoJ0dldHRpbmcgdGhlIEFQSSBjb25uZWN0aW9ucycpO1xuICAgICAgY29uc3QgaG9zdHMgPSAoYXdhaXQgdGhpcy5nZXQodW5kZWZpbmVkLCBvcHRpb25zKSkgYXMgSUFQSUhvc3RbXTtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdHZXR0aW5nIHJlZ2lzdHJ5Jyk7XG4gICAgICBjb25zdCByZWdpc3RyeSA9IE9iamVjdC5mcm9tRW50cmllcyhbLi4udGhpcy5jYWNoZVJlZ2lzdHJ5LmVudHJpZXMoKV0pO1xuICAgICAgcmV0dXJuIGhvc3RzLm1hcChob3N0ID0+IHtcbiAgICAgICAgY29uc3QgeyBpZCB9ID0gaG9zdDtcbiAgICAgICAgcmV0dXJuIHsgLi4uaG9zdCwgY2x1c3Rlcl9pbmZvOiByZWdpc3RyeVtpZF0gfTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNTZXJ2ZXJBUElDbGllbnRSZXNwb25zZU9rKHJlc3BvbnNlOiB7IHN0YXR1czogbnVtYmVyIH0pIHtcbiAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzID09PSBIVFRQX1NUQVRVU19DT0RFUy5PSztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGNsdXN0ZXIgaW5mbyBhbmQgYWxsb3dfcnVuX2FzIHZhbHVlcyBmb3IgdGhlIEFQSSBob3N0IGFuZCBzdG9yZSBpbnRvIHRoZSByZWdpc3RyeSBjYWNoZVxuICAgKiBAcGFyYW0gaG9zdFxuICAgKiBAcmV0dXJuc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZXRSZWdpc3RyeURhdGFCeUhvc3QoXG4gICAgaG9zdDogSUFQSUhvc3QsXG4gICAgb3B0aW9uczogR2V0UmVnaXN0cnlEYXRhQnlIb3N0T3B0aW9ucyxcbiAgKTogUHJvbWlzZTxJQVBJSG9zdFJlZ2lzdHJ5PiB7XG4gICAgY29uc3QgYXBpSG9zdElEID0gaG9zdC5pZDtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgR2V0dGluZyByZWdpc3RyeSBkYXRhIGZyb20gaG9zdCBbJHthcGlIb3N0SUR9XWApO1xuICAgIC8vIEdldCBjbHVzdGVyIGluZm8gZGF0YVxuXG4gICAgbGV0IG1hbmFnZXIgPSBudWxsLFxuICAgICAgbm9kZSA9IG51bGwsXG4gICAgICBzdGF0dXMgPSAnZGlzYWJsZWQnLFxuICAgICAgY2x1c3RlciA9ICdEaXNhYmxlZCcsXG4gICAgICBhbGxvd19ydW5fYXMgPSBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLlVOQUJMRV9UT19DSEVDSztcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZUFnZW50cyA9IGF3YWl0IHRoaXMuc2VydmVyQVBJQ2xpZW50LmFzSW50ZXJuYWxVc2VyLnJlcXVlc3QoXG4gICAgICAgICdHRVQnLFxuICAgICAgICBgL2FnZW50c2AsXG4gICAgICAgIHsgcGFyYW1zOiB7IGFnZW50c19saXN0OiAnMDAwJyB9IH0sXG4gICAgICAgIHsgYXBpSG9zdElEIH0sXG4gICAgICApO1xuXG4gICAgICBpZiAodGhpcy5pc1NlcnZlckFQSUNsaWVudFJlc3BvbnNlT2socmVzcG9uc2VBZ2VudHMpKSB7XG4gICAgICAgIG1hbmFnZXIgPSByZXNwb25zZUFnZW50cy5kYXRhLmRhdGEuYWZmZWN0ZWRfaXRlbXNbMF0ubWFuYWdlcjtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IGFsbG93X3J1bl9hc1xuICAgICAgY29uc3QgcmVzcG9uc2VBbGxvd1J1bkFzID1cbiAgICAgICAgYXdhaXQgdGhpcy5zZXJ2ZXJBUElDbGllbnQuYXNJbnRlcm5hbFVzZXIucmVxdWVzdChcbiAgICAgICAgICAnR0VUJyxcbiAgICAgICAgICAnL3NlY3VyaXR5L3VzZXJzL21lJyxcbiAgICAgICAgICB7fSxcbiAgICAgICAgICB7IGFwaUhvc3RJRCB9LFxuICAgICAgICApO1xuICAgICAgaWYgKHRoaXMuaXNTZXJ2ZXJBUElDbGllbnRSZXNwb25zZU9rKHJlc3BvbnNlQWxsb3dSdW5BcykpIHtcbiAgICAgICAgY29uc3QgYWxsb3dfcnVuX2FzX3Jlc3BvbnNlID1cbiAgICAgICAgICByZXNwb25zZUFsbG93UnVuQXMuZGF0YS5kYXRhLmFmZmVjdGVkX2l0ZW1zWzBdLmFsbG93X3J1bl9hcztcbiAgICAgICAgaWYgKGhvc3QucnVuX2FzKSB7XG4gICAgICAgICAgYWxsb3dfcnVuX2FzID0gYWxsb3dfcnVuX2FzX3Jlc3BvbnNlXG4gICAgICAgICAgICA/IEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuRU5BQkxFRFxuICAgICAgICAgICAgOiBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLlVTRVJfTk9UX0FMTE9XRUQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYWxsb3dfcnVuX2FzID0gYWxsb3dfcnVuX2FzX3Jlc3BvbnNlXG4gICAgICAgICAgICA/IEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuSE9TVF9ESVNBQkxFRFxuICAgICAgICAgICAgOiBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkFMTF9ESVNBQkxFRDtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCByZXNwb25zZUNsdXN0ZXJTdGF0dXMgPVxuICAgICAgICBhd2FpdCB0aGlzLnNlcnZlckFQSUNsaWVudC5hc0ludGVybmFsVXNlci5yZXF1ZXN0KFxuICAgICAgICAgICdHRVQnLFxuICAgICAgICAgIGAvY2x1c3Rlci9zdGF0dXNgLFxuICAgICAgICAgIHt9LFxuICAgICAgICAgIHsgYXBpSG9zdElEIH0sXG4gICAgICAgICk7XG5cbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy5pc1NlcnZlckFQSUNsaWVudFJlc3BvbnNlT2socmVzcG9uc2VDbHVzdGVyU3RhdHVzKSAmJlxuICAgICAgICByZXNwb25zZUNsdXN0ZXJTdGF0dXMuZGF0YT8uZGF0YT8uZW5hYmxlZCA9PT0gJ3llcydcbiAgICAgICkge1xuICAgICAgICBzdGF0dXMgPSAnZW5hYmxlZCc7XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2VDbHVzdGVyTG9jYWwgPVxuICAgICAgICAgIGF3YWl0IHRoaXMuc2VydmVyQVBJQ2xpZW50LmFzSW50ZXJuYWxVc2VyLnJlcXVlc3QoXG4gICAgICAgICAgICAnR0VUJyxcbiAgICAgICAgICAgIGAvY2x1c3Rlci9sb2NhbC9pbmZvYCxcbiAgICAgICAgICAgIHt9LFxuICAgICAgICAgICAgeyBhcGlIb3N0SUQgfSxcbiAgICAgICAgICApO1xuXG4gICAgICAgIGlmICh0aGlzLmlzU2VydmVyQVBJQ2xpZW50UmVzcG9uc2VPayhyZXNwb25zZUNsdXN0ZXJMb2NhbCkpIHtcbiAgICAgICAgICBub2RlID0gcmVzcG9uc2VDbHVzdGVyTG9jYWwuZGF0YS5kYXRhLmFmZmVjdGVkX2l0ZW1zWzBdLm5vZGU7XG4gICAgICAgICAgY2x1c3RlciA9IHJlc3BvbnNlQ2x1c3RlckxvY2FsLmRhdGEuZGF0YS5hZmZlY3RlZF9pdGVtc1swXS5jbHVzdGVyO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChvcHRpb25zPy50aHJvd0Vycm9yKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICBtYW5hZ2VyLFxuICAgICAgbm9kZSxcbiAgICAgIHN0YXR1cyxcbiAgICAgIGNsdXN0ZXIsXG4gICAgICBhbGxvd19ydW5fYXMsXG4gICAgfTtcbiAgICB0aGlzLnVwZGF0ZVJlZ2lzdHJ5QnlIb3N0KGFwaUhvc3RJRCwgZGF0YSk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0aGUgc2VydmljZSBvbiBwbHVnaW4gc3RhcnQuXG4gICAqIC0gR2V0IHRoZSByZWdpc3RyeSBkYXRhIGZvciB0aGUgY29uZmlndXJlZCBBUEkgaG9zdHMgYW5kIHN0b3JlIGludG8gdGhlIGluIG1lbW9yeSBjYWNoZVxuICAgKiBAcmV0dXJuc1xuICAgKi9cbiAgYXN5bmMgc3RhcnQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdTdGFydCcpO1xuICAgICAgY29uc3QgaG9zdHMgPSAoYXdhaXQgdGhpcy5nZXQodW5kZWZpbmVkLCB7XG4gICAgICAgIGV4Y2x1ZGVQYXNzd29yZDogdHJ1ZSxcbiAgICAgIH0pKSBhcyBJQVBJSG9zdFtdO1xuICAgICAgaWYgKCFob3N0cy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZGVidWcoJ05vIGhvc3RzIGZvdW5kLiBTa2lwLicpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBob3N0cy5tYXAoaG9zdCA9PlxuICAgICAgICAgIChhc3luYyAoKSA9PiBbaG9zdC5pZCwgYXdhaXQgdGhpcy5nZXRSZWdpc3RyeURhdGFCeUhvc3QoaG9zdCldKSgpLFxuICAgICAgICApLFxuICAgICAgKTtcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdBUEkgaG9zdHMgZGF0YSBzdG9yZWQgaW4gdGhlIHJlZ2lzdHJ5Jyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWdpc3RyeUJ5SG9zdChob3N0SUQ6IHN0cmluZykge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBHZXR0aW5nIGNhY2hlIGZvciBBUEkgaG9zdCBbJHtob3N0SUR9XWApO1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY2FjaGVSZWdpc3RyeS5nZXQoaG9zdElEKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgR2V0IGNhY2hlIGZvciBBUElob3N0IFske2hvc3RJRH1dYCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlUmVnaXN0cnlCeUhvc3QoaG9zdElEOiBzdHJpbmcsIGRhdGE6IGFueSkge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBVcGRhdGluZyBjYWNoZSBmb3IgQVBJaG9zdCBbJHtob3N0SUR9XWApO1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY2FjaGVSZWdpc3RyeS5zZXQoaG9zdElELCBkYXRhKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgVXBkYXRlZCBjYWNoZSBmb3IgQVBJaG9zdCBbJHtob3N0SUR9XWApO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIGRlbGV0ZVJlZ2lzdHJ5QnlIb3N0KGhvc3RJRDogc3RyaW5nKSB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYERlbGV0aW5nIGNhY2hlIGZvciBBUEkgaG9zdCBbJHtob3N0SUR9XWApO1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY2FjaGVSZWdpc3RyeS5kZWxldGUoaG9zdElEKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgRGVsZXRlZCBjYWNoZSBmb3IgQVBJIGhvc3QgWyR7aG9zdElEfV1gKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHRoZSBhdXRoZW50aWNhdGlvbiB3aXRoIHJ1bl9hcyBpcyBlbmFibGVkIGFuZCB0aGUgQVBJIHVzZXIgY2FuIHVzZSBpdFxuICAgKiBAcGFyYW0gYXBpSWRcbiAgICogQHJldHVybnNcbiAgICovXG4gIGlzRW5hYmxlZEF1dGhXaXRoUnVuQXMoYXBpSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBDaGVja2luZyBpZiB0aGUgQVBJIGhvc3QgWyR7YXBpSWR9XSBjYW4gdXNlIHRoZSBydW5fYXNgKTtcblxuICAgIGNvbnN0IHJlZ2lzdHJ5SG9zdCA9IHRoaXMuZ2V0UmVnaXN0cnlCeUhvc3QoYXBpSWQpO1xuICAgIGlmICghcmVnaXN0cnlIb3N0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBBUEkgaG9zdCB3aXRoIElEIFske2FwaUlkfV0gd2FzIG5vdCBmb3VuZCBpbiB0aGUgcmVnaXN0cnkuIFRoaXMgY291bGQgYmUgY2F1c2VkIGJ5IGEgcHJvYmxlbSBnZXR0aW5nIGFuZCBzdG9yaW5nIHRoZSByZWdpc3RyeSBkYXRhIG9yIHRoZSBBUEkgaG9zdCB3YXMgcmVtb3ZlZC5gLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHJlZ2lzdHJ5SG9zdC5hbGxvd19ydW5fYXMgPT09IEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuVU5BQkxFX1RPX0NIRUNLKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBBUEkgaG9zdCB3aXRoIGhvc3QgSUQgWyR7YXBpSWR9XSBjb3VsZCBub3QgY2hlY2sgdGhlIGFiaWxpdHkgdG8gdXNlIHRoZSBydW4gYXMuIEVuc3VyZSB0aGUgQVBJIGhvc3QgaXMgYWNjZXNpYmxlIGFuZCB0aGUgaW50ZXJuYWwgdXNlciBoYXMgdGhlIG1pbmltYWwgcGVybWlzc2lvbnMgdG8gY2hlY2sgdGhpcyBjYXBhYmlsaXR5LmAsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAocmVnaXN0cnlIb3N0LmFsbG93X3J1bl9hcyA9PT0gQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5VU0VSX05PVF9BTExPV0VEKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBBUEkgaG9zdCB3aXRoIGhvc3QgSUQgWyR7YXBpSWR9XSBtaXNjb25maWd1cmVkLiBUaGUgY29uZmlndXJhdGVkIEFQSSB1c2VyIGlzIG5vdCBhbGxvd2VkIHRvIHVzZSBbcnVuX2FzXS4gQWxsb3cgaXQgaW4gdGhlIEFQSSB1c2VyIGNvbmZpZ3VyYXRpb24gb3Igc2V0IFtydW5fYXNdIGhvc3Qgc2V0dGluZyB3aXRoIFtmYWxzZV0gdmFsdWUuYCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLyogVGhlIGFsbG93ZWQgdmFsdWVzIHRvIGNvbXBhcmUgc2hvdWxkIGJlOlxuICAgICAgQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5FTkFCTEVEOiB1c2UgcnVuX2FzXG4gICAgICBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkhPU1RfRElTQUJMRUQ6IG5vdCB1c2UgcnVuX2FzXG4gICAgICBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkFMTF9ESVNBQkxFRDogbm90IHVzZSBydW5fYXNcbiAgICAqL1xuICAgIGlmIChcbiAgICAgICFbXG4gICAgICAgIEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuRU5BQkxFRCxcbiAgICAgICAgQVBJX1VTRVJfU1RBVFVTX1JVTl9BUy5IT1NUX0RJU0FCTEVELFxuICAgICAgICBBUElfVVNFUl9TVEFUVVNfUlVOX0FTLkFMTF9ESVNBQkxFRCxcbiAgICAgIF0uaW5jbHVkZXMocmVnaXN0cnlIb3N0LmFsbG93X3J1bl9hcylcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEFQSSBob3N0IHdpdGggaG9zdCBJRCBbJHthcGlJZH1dIGhhcyBhbiB1bmV4cGVjdGVkIHZhbHVlIFske3JlZ2lzdHJ5SG9zdC5hbGxvd19ydW5fYXN9XSBzdG9yZWQgaW4gdGhlIHJlZ2lzdHJ5LiBUaGlzIGNvdWxkIGJlIGNhdXNlZCBieSBhIHByb2JsZW0gZ2V0dGluZyBhbmQgc3RvcmluZyB0aGUgcmVnaXN0cnkgZGF0YS5gLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlZ2lzdHJ5SG9zdC5hbGxvd19ydW5fYXMgPT09IEFQSV9VU0VSX1NUQVRVU19SVU5fQVMuRU5BQkxFRDtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFjQSxJQUFBQSxtQkFBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsVUFBQSxHQUFBRCxPQUFBO0FBQTJELFNBQUFFLGdCQUFBQyxHQUFBLEVBQUFDLEdBQUEsRUFBQUMsS0FBQSxJQUFBRCxHQUFBLEdB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